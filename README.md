# CCTV

current embedding -> SigLIP2 (google/siglip2-base-patch16-224) for image-to-text similarity search

structure modular under `src` directory

## Setup

### Qdrant Docker
```
docker compose up -d
```

### Feed data
sync qdrant client dependencies
```
uv sync
```
run python script to insert data with SigLIP2 embeddings
```
uv python3 import_to_qdrant.py --generate-embeddings --image-dir car_images
```

### Running up project
```
uv run main.py
```

## Endpoints (แก้ได้ตามใจ แล้วแต่ชอบ)

### POST `api/v1/search/query`
Original endpoint for vector search with pre-computed embeddings

```
{
  "query_embedding": [-0.011543015949428082, -0.06716793030500412, 0.04606954753398895, -0.0005743756773881614, -0.018710250034928322, 0.028688570484519005, 0.02987518347799778, 0.0390826053917408, 0.07500559091567993, 0.014977159909904003, 0.013245418667793274, 0.002806283300742507, 0.04259167239069939, 0.06283335387706757, 0.010713339783251286, 0.024985430762171745, 0.07061878591775894, 0.018620843067765236, -0.03426874801516533, -0.03358066827058792, 0.013949605636298656, -0.04742048680782318, 0.020654581487178802, -0.024454372003674507, 0.0024923912715166807, 0.03855038061738014, -0.02229474112391472, 0.049461159855127335, -0.03866277262568474, -0.12753546237945557, -0.018627898767590523, -0.003050505882129073, 0.055591512471437454, -0.01781027391552925, 0.05760226771235466, -0.040227364748716354, -0.04899640381336212, 0.07614775747060776, -0.012517724186182022, -0.01050939504057169, 0.03793690353631973, -0.002116723684594035, -0.056078214198350906, 0.03289410471916199, -0.04822312667965889, 0.004972551949322224, 0.004203713033348322, 0.022576037794351578, 0.07223181426525116, -0.09993264079093933, -0.0015793971251696348, -0.08031420409679413, 0.013649147003889084, 0.01590292900800705, -0.05527963489294052, 0.08541886508464813, 0.017582381144165993, -0.018316924571990967, 0.06869535893201828, -0.010695204138755798, 0.013549845665693283, 0.03397819399833679, -0.1629677712917328, 0.06467195600271225, 0.029577724635601044, -0.01709725521504879, -0.004690221976488829, -0.007194912992417812, 0.07350338995456696, 0.00832576397806406, 0.03638308867812157, -0.0050071668811142445, 0.09473671019077301, 0.025854816660284996, -0.033915068954229355, -0.07260088622570038, 0.016879169270396233, -0.054913319647312164, -0.05824308097362518, -0.04701315984129906, -0.03146209195256233, 0.00010380461753811687, -0.06515602022409439, -0.033478885889053345, 0.023601699620485306, -0.011387624777853489, -0.054554350674152374, 0.04677305743098259, 0.01685301586985588, -0.024929586797952652, -0.062299784272909164, -0.056692011654376984, -0.022398851811885834, -0.04592274874448776, -0.006752285175025463, 0.0003274710907135159, -0.03811831399798393, -0.04639125615358353, 0.014844095334410667, 0.3161858916282654, 0.007595889735966921, 0.05186785012483597, 0.07789567112922668, -0.04710937663912773, 0.008352828212082386, -0.002227774355560541, -0.046955183148384094, 0.015262807719409466, -0.055605724453926086, 0.011479733511805534, 0.055053967982530594, -0.03464088216423988, 0.08449208736419678, -0.05192236602306366, 0.03271287679672241, -0.029908671975135803, 0.055094409734010696, 0.029398063197731972, -0.04102284833788872, -0.013551965355873108, -0.01250092126429081, -0.039396174252033234, -0.010421892628073692, -0.036894116550683975, -0.003560189390555024, -0.0639628991484642, 0.1164923757314682, 0.0763966366648674, 0.014671910554170609, 0.05394892394542694, -0.028338763862848282, 0.029680423438549042, -0.021504681557416916, -0.013685621321201324, -0.025805870071053505, 0.03821290656924248, 0.018508974462747574, -0.0002400116209173575, -0.05291776359081268, 0.010888679884374142, -0.06998218595981598, -0.10985860973596573, 0.011834586039185524, -0.09075526893138885, 0.0473729632794857, 0.04222987964749336, -0.04847833141684532, 0.03573521226644516, -0.02791600301861763, 0.022410623729228973, -0.02455485612154007, 0.04396413266658783, 0.07786862552165985, -0.04763931781053543, 0.017553498968482018, 0.059814903885126114, -0.026532726362347603, 0.06834161281585693, -0.0037785167805850506, 0.02765839546918869, 0.03788531944155693, 0.005593446083366871, -0.014450150541961193, 0.014955654740333557, 0.007182891946285963, -0.11145269870758057, -0.007830396294593811, 0.051096633076667786, -0.026717714965343475, 0.0404084138572216, 0.04283956438302994, 0.07526139169931412, 0.00032431213185191154, 0.03409460932016373, 0.09056443721055984, -0.004685050807893276, -0.0281753521412611, 0.05065518990159035, -0.008199198171496391, 0.004337742459028959, 0.03901808708906174, 0.004301530309021473, -0.05530785396695137, 0.032899029552936554, 0.04577010124921799, 0.012194041162729263, -0.032518964260816574, 0.012510078027844429, 0.06777510792016983, 0.024177024140954018, -0.004492718726396561, -0.03607259690761566, -0.006967684254050255, 0.011346104554831982, -0.06966033577919006, -0.049639131873846054, -0.01635356806218624, -0.018467705696821213, -0.04593455046415329, -0.009304556995630264, 0.09074012190103531, 0.013366461731493473, -0.009629303589463234, 0.05139320343732834, 0.018250858411192894, 0.011736337095499039, -0.03407292813062668, 0.006357349455356598, 0.024074841290712357, -0.008883546106517315, -0.0542079396545887, 0.007546545006334782, 0.048928793519735336, -0.0014848960563540459, 0.05109633877873421, 0.0004716393887065351, -0.06286633759737015, -0.018582651391625404, 0.04645397514104843, -0.03660428896546364, -0.03783787414431572, 0.012599053792655468, -0.0611235536634922, -0.26185986399650574, 0.028498293831944466, -0.007588445208966732, 0.010251815430819988, -0.0576036274433136, -0.04132740572094917, 0.027923526242375374, 0.003208172507584095, 0.10918064415454865, -0.003379239933565259, -0.002103153383359313, -0.016022982075810432, 0.027068113908171654, 0.010303034447133541, 0.01802409254014492, 0.026644714176654816, 0.008881054818630219, 0.014418602921068668, 0.0253452081233263, -0.0002078896650345996, 0.04299524798989296, 0.03628743067383766, -0.06469029188156128, 0.002728999825194478, 0.0966031476855278, -0.0316542312502861, 0.17622074484825134, 7.257601828314364e-05, 0.02544322982430458, -0.06109797954559326, 0.06413964927196503, 0.030350320041179657, -0.03809194266796112, 0.023403337225317955, -0.015154879540205002, -0.01828613318502903, 0.017506863921880722, 0.012297595851123333, -0.1019086241722107, -0.03998161479830742, 0.02141883783042431, 0.03288618475198746, -0.025981158018112183, -0.06786516308784485, 0.0843663439154625, -0.01419023610651493, 0.007971671409904957, 0.04232533648610115, -0.05542325600981712, 0.06634420901536942, 0.045936401933431625, -0.006141621619462967, -0.01848510652780533, 0.071274034678936, 0.012978262268006802, -0.04554854705929756, -0.02904435060918331, -0.00908830389380455, 0.022836944088339806, -0.059100374579429626, -0.03468133509159088, 0.014071868732571602, 0.0501764751970768, -0.022550571709871292, -0.02887398935854435, 0.043870776891708374, -0.06257364153862, -0.06806878745555878, -0.03926429897546768, -0.07645896822214127, -0.03495806083083153, -0.022384125739336014, -0.04683155566453934, 0.057894349098205566, 0.04710472375154495, 0.020494692027568817, -0.014810344204306602, 0.03594896197319031, -0.022078102454543114, -0.06604249030351639, 0.006436225026845932, 0.009380782954394817, 0.04141368716955185, 0.014764794148504734, 0.04945667088031769, 0.016187187284231186, 0.04271761327981949, -0.01296363864094019, -0.023784298449754715, 0.001450383453629911, -0.020106520503759384, 0.005147095303982496, 0.013872383162379265, -0.025298448279500008, 0.066410131752491, -0.09146576374769211, -0.23427119851112366, 0.01430435013025999, -0.07678107172250748, -0.0045462376438081264, -0.05307644233107567, -0.03824884817004204, -0.04835972189903259, -0.009001079015433788, -0.05757170170545578, -0.04700743034482002, -0.07037384808063507, 0.05228805914521217, 0.007646833546459675, -0.024989668279886246, 0.009606404229998589, -0.0496891587972641, 0.048643555492162704, 0.01187396701425314, 0.0010373072000220418, 0.011201071552932262, -0.03442232683300972, -0.06730833649635315, 0.1443796306848526, 0.010988924652338028, 0.0362517423927784, 0.08653230220079422, -0.025224583223462105, 0.03627529740333557, 0.012181244790554047, 0.03343087062239647, 0.038396842777729034, 0.02047336846590042, 0.07008717954158783, -0.034077178686857224, -0.005395014304667711, 0.023152539506554604, -0.02508022077381611, 0.036168407648801804, -0.02285667322576046, 0.017683381214737892, -0.015586838126182556, 0.0853477343916893, -0.039388515055179596, -0.016522468999028206, 0.08090946078300476, -0.0524289570748806, 0.018992826342582703, 0.006280182860791683, 0.0059309727512300014, 0.045382849872112274, 0.03887416794896126, -0.008179843425750732, -0.09197378903627396, -0.024296147748827934, -0.0016746933106333017, -0.02784901112318039, -0.10074134171009064, -0.09406076371669769, 0.049296461045742035, 0.016531791538000107, -0.012757997028529644, -0.006542603485286236, 0.0010756842093542218, -0.011345861479640007, 0.054342638701200485],
  "collection_name": "car_embeddings",
  "similarity_threshold": 0.7,
  "start_date": "2025-01-01",
  "limit": 10
}
```
or curl
```
curl --location 'http://localhost:8000/api/v1/search/query' \
--header 'Content-Type: application/json' \
--data '{
  "query_embedding": [-0.011543015949428082, -0.06716793030500412, 0.04606954753398895, -0.0005743756773881614, -0.018710250034928322, 0.028688570484519005, 0.02987518347799778, 0.0390826053917408, 0.07500559091567993, 0.014977159909904003, 0.013245418667793274, 0.002806283300742507, 0.04259167239069939, 0.06283335387706757, 0.010713339783251286, 0.024985430762171745, 0.07061878591775894, 0.018620843067765236, -0.03426874801516533, -0.03358066827058792, 0.013949605636298656, -0.04742048680782318, 0.020654581487178802, -0.024454372003674507, 0.0024923912715166807, 0.03855038061738014, -0.02229474112391472, 0.049461159855127335, -0.03866277262568474, -0.12753546237945557, -0.018627898767590523, -0.003050505882129073, 0.055591512471437454, -0.01781027391552925, 0.05760226771235466, -0.040227364748716354, -0.04899640381336212, 0.07614775747060776, -0.012517724186182022, -0.01050939504057169, 0.03793690353631973, -0.002116723684594035, -0.056078214198350906, 0.03289410471916199, -0.04822312667965889, 0.004972551949322224, 0.004203713033348322, 0.022576037794351578, 0.07223181426525116, -0.09993264079093933, -0.0015793971251696348, -0.08031420409679413, 0.013649147003889084, 0.01590292900800705, -0.05527963489294052, 0.08541886508464813, 0.017582381144165993, -0.018316924571990967, 0.06869535893201828, -0.010695204138755798, 0.013549845665693283, 0.03397819399833679, -0.1629677712917328, 0.06467195600271225, 0.029577724635601044, -0.01709725521504879, -0.004690221976488829, -0.007194912992417812, 0.07350338995456696, 0.00832576397806406, 0.03638308867812157, -0.0050071668811142445, 0.09473671019077301, 0.025854816660284996, -0.033915068954229355, -0.07260088622570038, 0.016879169270396233, -0.054913319647312164, -0.05824308097362518, -0.04701315984129906, -0.03146209195256233, 0.00010380461753811687, -0.06515602022409439, -0.033478885889053345, 0.023601699620485306, -0.011387624777853489, -0.054554350674152374, 0.04677305743098259, 0.01685301586985588, -0.024929586797952652, -0.062299784272909164, -0.056692011654376984, -0.022398851811885834, -0.04592274874448776, -0.006752285175025463, 0.0003274710907135159, -0.03811831399798393, -0.04639125615358353, 0.014844095334410667, 0.3161858916282654, 0.007595889735966921, 0.05186785012483597, 0.07789567112922668, -0.04710937663912773, 0.008352828212082386, -0.002227774355560541, -0.046955183148384094, 0.015262807719409466, -0.055605724453926086, 0.011479733511805534, 0.055053967982530594, -0.03464088216423988, 0.08449208736419678, -0.05192236602306366, 0.03271287679672241, -0.029908671975135803, 0.055094409734010696, 0.029398063197731972, -0.04102284833788872, -0.013551965355873108, -0.01250092126429081, -0.039396174252033234, -0.010421892628073692, -0.036894116550683975, -0.003560189390555024, -0.0639628991484642, 0.1164923757314682, 0.0763966366648674, 0.014671910554170609, 0.05394892394542694, -0.028338763862848282, 0.029680423438549042, -0.021504681557416916, -0.013685621321201324, -0.025805870071053505, 0.03821290656924248, 0.018508974462747574, -0.0002400116209173575, -0.05291776359081268, 0.010888679884374142, -0.06998218595981598, -0.10985860973596573, 0.011834586039185524, -0.09075526893138885, 0.0473729632794857, 0.04222987964749336, -0.04847833141684532, 0.03573521226644516, -0.02791600301861763, 0.022410623729228973, -0.02455485612154007, 0.04396413266658783, 0.07786862552165985, -0.04763931781053543, 0.017553498968482018, 0.059814903885126114, -0.026532726362347603, 0.06834161281585693, -0.0037785167805850506, 0.02765839546918869, 0.03788531944155693, 0.005593446083366871, -0.014450150541961193, 0.014955654740333557, 0.007182891946285963, -0.11145269870758057, -0.007830396294593811, 0.051096633076667786, -0.026717714965343475, 0.0404084138572216, 0.04283956438302994, 0.07526139169931412, 0.00032431213185191154, 0.03409460932016373, 0.09056443721055984, -0.004685050807893276, -0.0281753521412611, 0.05065518990159035, -0.008199198171496391, 0.004337742459028959, 0.03901808708906174, 0.004301530309021473, -0.05530785396695137, 0.032899029552936554, 0.04577010124921799, 0.012194041162729263, -0.032518964260816574, 0.012510078027844429, 0.06777510792016983, 0.024177024140954018, -0.004492718726396561, -0.03607259690761566, -0.006967684254050255, 0.011346104554831982, -0.06966033577919006, -0.049639131873846054, -0.01635356806218624, -0.018467705696821213, -0.04593455046415329, -0.009304556995630264, 0.09074012190103531, 0.013366461731493473, -0.009629303589463234, 0.05139320343732834, 0.018250858411192894, 0.011736337095499039, -0.03407292813062668, 0.006357349455356598, 0.024074841290712357, -0.008883546106517315, -0.0542079396545887, 0.007546545006334782, 0.048928793519735336, -0.0014848960563540459, 0.05109633877873421, 0.0004716393887065351, -0.06286633759737015, -0.018582651391625404, 0.04645397514104843, -0.03660428896546364, -0.03783787414431572, 0.012599053792655468, -0.0611235536634922, -0.26185986399650574, 0.028498293831944466, -0.007588445208966732, 0.010251815430819988, -0.0576036274433136, -0.04132740572094917, 0.027923526242375374, 0.003208172507584095, 0.10918064415454865, -0.003379239933565259, -0.002103153383359313, -0.016022982075810432, 0.027068113908171654, 0.010303034447133541, 0.01802409254014492, 0.026644714176654816, 0.008881054818630219, 0.014418602921068668, 0.0253452081233263, -0.0002078896650345996, 0.04299524798989296, 0.03628743067383766, -0.06469029188156128, 0.002728999825194478, 0.0966031476855278, -0.0316542312502861, 0.17622074484825134, 7.257601828314364e-05, 0.02544322982430458, -0.06109797954559326, 0.06413964927196503, 0.030350320041179657, -0.03809194266796112, 0.023403337225317955, -0.015154879540205002, -0.01828613318502903, 0.017506863921880722, 0.012297595851123333, -0.1019086241722107, -0.03998161479830742, 0.02141883783042431, 0.03288618475198746, -0.025981158018112183, -0.06786516308784485, 0.0843663439154625, -0.01419023610651493, 0.007971671409904957, 0.04232533648610115, -0.05542325600981712, 0.06634420901536942, 0.045936401933431625, -0.006141621619462967, -0.01848510652780533, 0.071274034678936, 0.012978262268006802, -0.04554854705929756, -0.02904435060918331, -0.00908830389380455, 0.022836944088339806, -0.059100374579429626, -0.03468133509159088, 0.014071868732571602, 0.0501764751970768, -0.022550571709871292, -0.02887398935854435, 0.043870776891708374, -0.06257364153862, -0.06806878745555878, -0.03926429897546768, -0.07645896822214127, -0.03495806083083153, -0.022384125739336014, -0.04683155566453934, 0.057894349098205566, 0.04710472375154495, 0.020494692027568817, -0.014810344204306602, 0.03594896197319031, -0.022078102454543114, -0.06604249030351639, 0.006436225026845932, 0.009380782954394817, 0.04141368716955185, 0.014764794148504734, 0.04945667088031769, 0.016187187284231186, 0.04271761327981949, -0.01296363864094019, -0.023784298449754715, 0.001450383453629911, -0.020106520503759384, 0.005147095303982496, 0.013872383162379265, -0.025298448279500008, 0.066410131752491, -0.09146576374769211, -0.23427119851112366, 0.01430435013025999, -0.07678107172250748, -0.0045462376438081264, -0.05307644233107567, -0.03824884817004204, -0.04835972189903259, -0.009001079015433788, -0.05757170170545578, -0.04700743034482002, -0.07037384808063507, 0.05228805914521217, 0.007646833546459675, -0.024989668279886246, 0.009606404229998589, -0.0496891587972641, 0.048643555492162704, 0.01187396701425314, 0.0010373072000220418, 0.011201071552932262, -0.03442232683300972, -0.06730833649635315, 0.1443796306848526, 0.010988924652338028, 0.0362517423927784, 0.08653230220079422, -0.025224583223462105, 0.03627529740333557, 0.012181244790554047, 0.03343087062239647, 0.038396842777729034, 0.02047336846590042, 0.07008717954158783, -0.034077178686857224, -0.005395014304667711, 0.023152539506554604, -0.02508022077381611, 0.036168407648801804, -0.02285667322576046, 0.017683381214737892, -0.015586838126182556, 0.0853477343916893, -0.039388515055179596, -0.016522468999028206, 0.08090946078300476, -0.0524289570748806, 0.018992826342582703, 0.006280182860791683, 0.0059309727512300014, 0.045382849872112274, 0.03887416794896126, -0.008179843425750732, -0.09197378903627396, -0.024296147748827934, -0.0016746933106333017, -0.02784901112318039, -0.10074134171009064, -0.09406076371669769, 0.049296461045742035, 0.016531791538000107, -0.012757997028529644, -0.006542603485286236, 0.0010756842093542218, -0.011345861479640007, 0.054342638701200485],
  "collection_name": "car_embeddings",
  "similarity_threshold": 0.7,
  "start_date": "2025-01-01",
  "limit": 10
}'
```

### POST `api/v1/images/search`
New endpoint for image-to-text similarity search using SigLIP2

```
{
  "text_query": "red sports car",
  "collection_name": "car_embeddings",
  "similarity_threshold": 0.7,
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "limit": 10
}
```

or curl
```
curl --location 'http://localhost:8000/api/v1/images/search' \
--header 'Content-Type: application/json' \
--data '{
  "text_query": "red sports car",
  "collection_name": "car_embeddings",
  "similarity_threshold": 0.7,
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "limit": 10
}'
```

### POST `api/v1/images/upload-and-search`
Upload an image and search for similar images using text query

```
curl --location 'http://localhost:8000/api/v1/images/upload-and-search' \
--form 'image=@"/path/to/your/image.jpg"' \
--form 'text_query="red sports car"' \
--form 'collection_name="car_embeddings"' \
--form 'similarity_threshold=0.7' \
--form 'limit=10'
```

## Testing

### Test API Endpoints
Run the test script to verify all endpoints are working correctly:
```
uv python test_api.py
```

### Test Image-to-Text Search
Run the example script to see the image-to-text search in action:
```
uv python example_usage.py
```

### Test SigLIP2 Embeddings
Run the embedding test script to verify SigLIP2 is working:
```
uv python test_image_search.py
```